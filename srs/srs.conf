# SRS Configuration for Low-Latency Livestreaming on Raspberry Pi 3
# Optimized for relay mode (no transcoding) to minimize CPU usage

listen              1935;
max_connections     50;
daemon              off;
srs_log_tank        console;

# HTTP API for monitoring and management
http_api {
    enabled         on;
    listen          1985;
    crossdomain     on;
}

# HTTP Server for HTTP-FLV streaming
http_server {
    enabled         on;
    listen          8080;
    dir             ./objs/nginx/html;
}

# Statistics for monitoring
stats {
    network         0;
    disk            sda vda xvda xvdb;
}

# Default vhost for all streams
vhost __defaultVhost__ {
    # Enable minimum latency mode (fast path)
    min_latency     on;

    # TCP optimizations for low latency
    tcp_nodelay     on;

    # Ultra-low latency: minimal GOP cache (0.5s max for new viewers)
    gop_cache       off;
    gop_cache_max_frames    0;

    # Queue length (minimal buffering for ultra-low latency)
    queue_length    3;

    # HTTP hooks for authentication and session management
    http_hooks {
        enabled         on;
        on_publish      http://web-api:3000/api/hooks/on_publish;
        on_unpublish    http://web-api:3000/api/hooks/on_unpublish;
        on_play         http://web-api:3000/api/hooks/on_play;
        on_stop         http://web-api:3000/api/hooks/on_stop;
    }

    # HTTP-FLV streaming (low latency ~1s, OBS/VLC compatible)
    http_remux {
        enabled     on;
        mount       [vhost]/[app]/[stream].flv;
        fast_cache  2;
    }

    # RTMP publishing settings (ultra-low latency)
    publish {
        # Minimum receive latency (100ms for ultra-low latency)
        mr          on;
        mr_latency  100;
    }

    # Playback settings (ultra-low latency)
    play {
        # No GOP cache for lowest latency
        gop_cache       off;
        queue_length    3;

        # Minimum send latency (100ms)
        mw_latency      100;

        # TCP nodelay
        mix_correct     on;
    }

    # SRT configuration (ultra-low latency, supports unreliable networks)
    srt {
        enabled     on;
        # SRT mode for this vhost (default is off, which means it accepts both publish and play)
        srt_to_rtmp on;
    }

    # WebRTC for ultra-low latency (< 500ms)
    rtc {
        enabled     on;
        # RTMP to RTC
        rtmp_to_rtc on;
        # Keep alive
        keep_bframe off;
    }

    # HLS (disabled by default, enable if needed for compatibility)
    hls {
        enabled         off;
    }

    # DVR (recording, disabled by default)
    dvr {
        enabled         off;
    }
}

# SRT Server configuration
srt_server {
    enabled         on;
    listen          10080;
    maxbw           1000000000;
    connect_timeout 4000;
    peerlatency     0;
    recvlatency     0;
    latency         20;
    tsbpdmode       off;
    tlpktdrop       on;
    sendbuf         2000000;
    recvbuf         2000000;
}

# WebRTC Server configuration (ultra-low latency < 500ms)
rtc_server {
    enabled         on;
    listen          8000;
    # For local network, use candidate with private IP
    candidate       $CANDIDATE;
}
