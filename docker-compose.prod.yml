# Production Docker Compose using pre-built images from GitHub Container Registry
# Usage: docker-compose -f docker-compose.prod.yml up -d

services:
  srs:
    image: ossrs/srs:5
    container_name: livestream-srs
    restart: unless-stopped
    command: ["./objs/srs", "-c", "conf/srs.conf"]
    ports:
      - "1935:1935"      # RTMP
      - "10080:10080/udp"    # SRT (UDP protocol)
      - "1985:1985"      # HTTP API
      - "8080:8080"      # HTTP-FLV
      - "8000:8000/udp"  # WebRTC
    volumes:
      - ./srs/srs.conf:/usr/local/srs/conf/srs.conf:ro
    environment:
      - CANDIDATE=${SERVER_IP:-192.168.1.55}
    networks:
      - livestream-network
    mem_limit: 256m
    cpus: 1.5

  web-api:
    image: ghcr.io/nyonnguyen/livestream-server/web-api:latest
    container_name: livestream-api
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./data:/app/data
      - ./VERSION:/app/VERSION:ro
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - SERVER_IP=${SERVER_IP}
      - JWT_SECRET=${JWT_SECRET}
      - DEFAULT_ADMIN_PASSWORD=${DEFAULT_ADMIN_PASSWORD}
      - MAX_CONCURRENT_STREAMS=${MAX_CONCURRENT_STREAMS:-3}
      - DB_PATH=${DB_PATH:-/app/data/livestream.db}
      - SRS_HTTP_API_URL=${SRS_HTTP_API_URL:-http://srs:1985/api/v1}
      - API_PORT=${API_PORT:-3000}
      - API_RATE_LIMIT_WINDOW=${API_RATE_LIMIT_WINDOW:-15}
      - API_RATE_LIMIT_MAX_REQUESTS=${API_RATE_LIMIT_MAX_REQUESTS:-5}
      - DEFAULT_STREAM_KEY_1=${DEFAULT_STREAM_KEY_1}
      - DEFAULT_STREAM_KEY_2=${DEFAULT_STREAM_KEY_2}
      - DEFAULT_STREAM_KEY_3=${DEFAULT_STREAM_KEY_3}
    depends_on:
      - srs
    networks:
      - livestream-network
    mem_limit: 128m
    cpus: 0.5

  web-ui:
    image: ghcr.io/nyonnguyen/livestream-server/web-ui:latest
    container_name: livestream-ui
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - web-api
    networks:
      - livestream-network
    mem_limit: 64m
    cpus: 0.5

  nginx:
    image: nginx:alpine
    container_name: livestream-nginx
    restart: unless-stopped
    ports:
      - "8888:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    depends_on:
      - srs
      - web-api
      - web-ui
    networks:
      - livestream-network
    mem_limit: 32m
    cpus: 0.3

networks:
  livestream-network:
    driver: bridge
